<script setup lang="tsx">
import { ContentWrap } from '@/components/ContentWrap'
import { ref } from 'vue'
import {
  ElSelect,
  ElOption,
  ElTabs,
  ElTabPane,
  ElSwitch,
  ElDialog,
  ElButton,
  ElIcon,
  ElMessage,
  ElRadioGroup,
  ElRadio,
  ElTable,
  ElTableColumn,
  ElCheckbox
} from 'element-plus'
import type { TabsPaneContext } from 'element-plus'
import level1 from '@/assets/imgs/level1.png'
import level2 from '@/assets/imgs/level2.png'
import level3 from '@/assets/imgs/level3.png'
import level4 from '@/assets/imgs/level4.png'
import { WarningFilled } from '@element-plus/icons-vue'

const options = [
  { value: 'all', label: '全部' },
  { value: 'beijing', label: '北京' },
  { value: 'shanghai', label: '上海' },
  { value: 'guangzhou', label: '广州' }
]
const levelOptions = [
  {
    id: 1,
    title: '严格',
    content: '包含对复杂攻击的检测规则，严格等级下会包含所有规则等级为宽松、正常及严格的规则',
    img: level1
  },
  {
    id: 2,
    title: '正常',
    content:
      '包含某类攻击的通用检测规则或误报较少的规则，正常等级时会包含所有规则等级为宽松及正常的规则',
    img: level2
  },
  {
    id: 3,
    title: '宽松',
    content:
      '适用于防护攻击特征较为明显的请求及其他防护等级下误报较多的场景，包含所有规则等级为宽松的规则',
    img: level3
  },
  {
    id: 4,
    title: '自定义',
    content: '自定义需要启用的规则，适用于灵活配置场景',
    img: level4
  }
]
const currentLevel = ref(1)
const targetLevelId = ref()
const activeName = ref('first')
const selectedValues = ref<string[]>([])
interface User {
  id: number
  name: string
  content: string
  number: number
  hasChildren?: boolean
  children?: User[]
}
const tableData: User[] = [
  {
    id: 1,
    name: '常规检测',
    content:
      '对常见的SQL注入、命令注入、表达式注入、XPath注入、LDAP注入、任意文件读&目录遍历、LFI、SSTI、SSRF、XSS等漏洞攻击检测及防护',
    number: 283,
    children: [
      {
        id: 31,
        name: '逻辑漏洞',
        content:
          '对常见的SQL注入、命令注入、表达式注入、XPath注入、LDAP注入、任意文件读&目录遍历、LFI、SSTI、SSRF、XSS等漏洞攻击检测及防护',
        number: 283
      },
      {
        id: 32,
        name: '逻辑漏洞',
        content:
          '对常见的SQL注入、命令注入、表达式注入、XPath注入、LDAP注入、任意文件读&目录遍历、LFI、SSTI、SSRF、XSS等漏洞攻击检测及防护',
        number: 283
      }
    ]
  },
  {
    id: 2,
    name: '逻辑漏洞',
    content: '对部分中间件存在越权、表单绕过漏洞进行检测与拦截',
    number: 283,
    children: [
      {
        id: 31,
        name: '逻辑漏洞',
        content:
          '对常见的SQL注入、命令注入、表达式注入、XPath注入、LDAP注入、任意文件读&目录遍历、LFI、SSTI、SSRF、XSS等漏洞攻击检测及防护',
        number: 283
      },
      {
        id: 32,
        name: '逻辑漏洞',
        content:
          '对常见的SQL注入、命令注入、表达式注入、XPath注入、LDAP注入、任意文件读&目录遍历、LFI、SSTI、SSRF、XSS等漏洞攻击检测及防护',
        number: 283
      }
    ]
  },
  {
    id: 3,
    name: 'Web后门',
    content: '通过对以asp、php、jsp或者cgi等网页文件形式存在的Web命令进行检测，拦截网页木马',
    number: 283,
    children: [
      {
        id: 31,
        name: '逻辑漏洞',
        content:
          '对常见的SQL注入、命令注入、表达式注入、XPath注入、LDAP注入、任意文件读&目录遍历、LFI、SSTI、SSRF、XSS等漏洞攻击检测及防护',
        number: 283
      },
      {
        id: 32,
        name: '逻辑漏洞',
        content:
          '对常见的SQL注入、命令注入、表达式注入、XPath注入、LDAP注入、任意文件读&目录遍历、LFI、SSTI、SSRF、XSS等漏洞攻击检测及防护',
        number: 283
      }
    ]
  },
  {
    id: 4,
    name: '扫描工具',
    content: '漏洞扫描工具是一种自动化工具，用于检测系统、应用程序或网络中的安全漏洞。',
    number: 283,
    children: [
      {
        id: 31,
        name: '逻辑漏洞',
        content:
          '对常见的SQL注入、命令注入、表达式注入、XPath注入、LDAP注入、任意文件读&目录遍历、LFI、SSTI、SSRF、XSS等漏洞攻击检测及防护',
        number: 283
      },
      {
        id: 32,
        name: '逻辑漏洞',
        content:
          '对常见的SQL注入、命令注入、表达式注入、XPath注入、LDAP注入、任意文件读&目录遍历、LFI、SSTI、SSRF、XSS等漏洞攻击检测及防护',
        number: 283
      }
    ]
  }
]
const handleChange = (val: string[]) => {
  if (val.includes('all')) {
    // 选中“全部” → 只保留 all
    selectedValues.value = ['all']
  } else {
    // 选中其他 → 去掉 all
    selectedValues.value = val.filter((v) => v !== 'all')
  }
}
const handleClick = (tab: TabsPaneContext, event: Event) => {
  console.log(tab, event)
}
const queryForm = ref({ isOpen: false, action: '1' })
const dialogVisible = ref(false)
const switchDialogVisible = ref(false)
let resolveFn: (val: boolean) => void
// 修改防护等级弹窗
const handleClickLevel = (id) => {
  if (targetLevelId.value === id) return
  dialogVisible.value = true
  targetLevelId.value = id
}
const handleConfirm = () => {
  dialogVisible.value = false
  currentLevel.value = targetLevelId.value
  ElMessage.success('修改成功')
}
// switch 切换前触发，返回 true 才会改变开关
const handleBeforeChange = () => {
  return new Promise<boolean>((resolve) => {
    switchDialogVisible.value = true
    resolveFn = resolve
    ElMessage.closeAll()
  })
}
const handleConfirmSwitch = () => {
  switchDialogVisible.value = false
  const actionText = queryForm.value.isOpen ? '关闭' : '开启'
  ElMessage.success({ message: `${actionText}成功`, grouping: false })
  resolveFn(true) // 允许切换
}
</script>

<template>
  <ContentWrap>
    <div class="page-title">选择域名</div>
    <div class="bottom-10">
      <p class="form-lable">域名</p>
      <ElSelect
        v-model="selectedValues"
        multiple
        collapse-tags
        collapse-tags-tooltip
        :max-collapse-tags="3"
        style="width: 240px"
        @change="handleChange"
      >
        <ElOption v-for="item in options" :key="item.value" :label="item.label" :value="item.value">
          <!-- 自定义复选框 + 文本 -->
          <el-checkbox
            :model-value="selectedValues.includes(item.value)"
            style="margin-right: 8px"
          />
          <span>{{ item.label }}</span>
        </ElOption>
      </ElSelect>
    </div>
    <div class="page-title-second">配置防护策略</div>
    <el-tabs v-model="activeName" type="card" class="demo-tabs" @tab-click="handleClick">
      <el-tab-pane label="漏洞防护" name="first">
        <div
          ><span class="page-title-third">漏洞防护</span
          ><el-switch v-model="queryForm.isOpen" :before-change="handleBeforeChange" />
          <span class="page-info"
            >对常见的Web应用攻击，如SQL注入、XSS攻击、网页挂马等提供安全防护能力。</span
          ></div
        >
        <ul class="ul-continer">
          <li
            v-for="item in levelOptions"
            :key="item.id"
            :class="{ active: currentLevel === item.id }"
            @click="handleClickLevel(item.id)"
          >
            <img :src="item.img" alt="" />
            <div
              ><p>{{ item.title }}</p>
              <span>{{ item.content }}</span>
            </div>
          </li>
        </ul>
        <div
          ><span class="page-title-third">扫描防护</span>
          <span class="page-info-second"
            >适用于信息收集、后台扫描、漏洞扫描场景下对攻击源的检测与封禁</span
          ></div
        >
        <div
          ><span class="page-title-third">防护动作：</span
          ><el-radio-group v-model="queryForm.action">
            <el-radio value="1" size="large">观察</el-radio>
            <el-radio value="2" size="large">拦截</el-radio>
          </el-radio-group></div
        >
        <el-table :data="tableData" style="width: 100%; margin: 20px 0" row-key="id" border>
          <el-table-column prop="name" label="防护类型" width="150" />
          <el-table-column prop="content" label="规则描述" />
          <el-table-column prop="number" label="规则数" width="100" />
        </el-table>
      </el-tab-pane>
    </el-tabs>
    <!-- 更改防护等级弹框 -->
    <el-dialog v-model="dialogVisible" width="600">
      <template #header>
        <el-icon style="margin-right: 6px; color: #e6a23c" :size="20">
          <WarningFilled />
        </el-icon>
        更改防护等级确认
      </template>
      <span>更改防护等级后将会立即生效，请谨慎操作</span>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="dialogVisible = false">取消</el-button>
          <el-button type="primary" @click="handleConfirm"> 确定 </el-button>
        </div>
      </template>
    </el-dialog>
    <!-- 更改漏洞防护开关状态弹框 -->
    <el-dialog v-model="switchDialogVisible" width="600">
      <template #header>
        <el-icon style="margin-right: 6px; color: #e6a23c" :size="20">
          <WarningFilled />
        </el-icon>
        更改功能开关确认
      </template>
      <span>更改防护策略功能开关后将会立即生效，请谨慎操作</span>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="switchDialogVisible = false">取消</el-button>
          <el-button type="primary" @click="handleConfirmSwitch"> 确定 </el-button>
        </div>
      </template>
    </el-dialog>
  </ContentWrap>
</template>

<style lang="less" scoped>
.el-button {
  margin-top: 10px;
}
.page-title {
  font-size: 18px;
  line-height: 26px;
  color: #0c0d0e;
  margin-bottom: 20px;
}
.form-lable {
  font-size: 13px;
  color: #42464e;
  display: inline-block;
  margin-right: 10px;
}
.bottom-10 {
  margin-bottom: 10px;
}
.page-title-second {
  font-size: 18px;
  margin: 40px 0 10px;
}
.page-title-third {
  font-size: 14px;
  margin-right: 16px;
}
.page-info {
  color: #42464e;
  margin-left: 20px;
}
.page-info-second {
  color: #42464e;
}
.ul-continer {
  display: flex;
  justify-content: space-around;
  margin: 20px 0;
  li {
    width: 20%;
    display: flex;
    flex: 1 1;
    -moz-box-align: center;
    align-items: center;
    border: 1px solid #eaedf1;
    border-radius: 4px;
    cursor: pointer;
    padding: 12px 16px;
    -moz-transition: all 0.1s linear;
    transition: all 0.1s linear;
    margin: 0 10px;
    &:hover {
      border: 1px solid #4e83ff;
    }
    img {
      width: 28px;
      margin-right: 16px;
    }
    p {
      color: #0c0d0e;
      margin-bottom: 6px;
      font-size: 14px;
    }
    span {
      color: #42464e;
      font-size: 12px;
    }
  }
  .active {
    border: 1px solid #4e83ff;
  }
}
</style>
